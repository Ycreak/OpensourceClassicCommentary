<!-- I think this can be removed. -->
<script src="vendor/jquery/jquery.min.js"></script>
<script src="vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Raleway">

<!-- Maybe we should get a local stylesheet? -->
<link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">

<!-- Navigation bar -->
<mat-toolbar color="primary">
    <span style="width: fit-content; transform: translateY(-1px)">
        <h3 class='h3-title'>Open Source Classics Commentary (Staging)</h3></span>
    <span class="spacer"></span>
    <button mat-button class="btn" (click)="test('8')" *ngIf="this.auth_service.current_user_role == 'teacher'"> TEST</button>

    <!-- Routing buttons -->
    <button mat-button class="btn" routerLink="/dashboard" *ngIf="this.auth_service.is_logged_in">DASHBOARD</button>

    <button mat-button class="btn" (click)="add_column()"> ADD FRAGMENT COLUMN</button>

    <!-- Column toggle buttons -->
    <mat-checkbox class="btn" ngDefaultControl [(ngModel)]="toggle_commentary">COMMENTARY</mat-checkbox>
    <mat-checkbox class="btn" ngDefaultControl [(ngModel)]="toggle_playground">PLAYGROUND</mat-checkbox>
    <button mat-button class="btn" [matMenuTriggerFor]="menu">MENU</button>
</mat-toolbar>

<!-- Navigation bar menu -->
<mat-menu #menu="matMenu">
    <!-- <button routerLink="/text" mat-menu-item>Text OSCC</button> -->
    <button (click)="login()" mat-menu-item>Login</button>
    <button routerLink="/scansion" mat-menu-item *ngIf="this.auth_service.is_logged_in">Scansion</button>
    <a href="https://github.com/Ycreak/OpensourceClassicCommentary/" target='_blank' mat-menu-item>Documentation</a>
    <button (click)="open_settings()" mat-menu-item>Settings</button>
    <button routerLink="/tests" mat-menu-item *ngIf="this.auth_service.is_logged_in">Unit Tests</button>
    <button (click)="this.dialog.open_about_dialog()" mat-menu-item>About</button>
    <button mat-menu-item>V22.11.09</button>
</mat-menu>

<!-- Loading spinner to show data is being retrieved from the server -->
<mat-toolbar *ngIf="this.utility.spinner === false" class="progress-toolbar"></mat-toolbar>
<mat-progress-bar *ngIf="this.utility.spinner" mode="query"></mat-progress-bar>

<!-- Secondary toolbar to manage columns -->
<mat-toolbar class="button-toolbar">    
    <div *ngFor="let column_to_display of this.columns">
        <!-- Checkbox to hide and show columns -->
        <mat-checkbox class="btn checkbox-button-toolbar" ngDefaultControl [(ngModel)]="column_to_display.visible">{{column_to_display.author}}-{{column_to_display.title}}-{{column_to_display.editor}}</mat-checkbox>
        <!-- Buttons to close columns or to move columns to left and right -->
        <button mat-icon-button (click)="move_column(column_to_display.column_id, 'left')">
            <mat-icon>keyboard_arrow_left</mat-icon>
        </button>  
        <button mat-icon-button (click)="move_column(column_to_display.column_id, 'right')">
            <mat-icon>keyboard_arrow_right</mat-icon>
        </button>  
        <button mat-icon-button (click)="close_column(column_to_display.column_id)">
            <mat-icon>clear</mat-icon>
        </button>  

        | <!-- Separator-->

    </div>
</mat-toolbar>

<div class="div-padding-sm"></div>

<!-- Display for if server is down -->
<div *ngIf="this.api.get_network_status() === false" class="alert alert-warning" role="alert" @fadeSlideInOut>
    Your client cannot connect to the server. Please check if you have the latest version of your browser installed. Furthermore, secured networks like DUWO and Leiden University are known to cause problems. Also, please click <u><a href="https://oscc.lucdh.nl">the following URL</a></u> for the best results. Please contact the administrators if problems are still occuring.
</div>

<!-- Container for the page. One row per item (commentary, playground, multiplayer, etc.) -->
<div class="container-fluid">

    <div class="row"> <!-- Row that contains the columns and commentary --> 
        <div *ngFor="let column_to_display of this.columns" class="col overflow_column" [hidden]="!column_to_display.visible">
                <ng-container [ngTemplateOutlet]='fragment_column_template' [ngTemplateOutletContext]="{given_column:column_to_display}"></ng-container>
        </div>

        <!-- Column with commentary, shown if a fragment from the edition of reference is clicked -->
        <div *ngIf="toggle_commentary" class="col overflow_column">
            <!-- Show either fragment data or the fact that no fragment has been selected yet. -->
            <div *ngIf="this.fragment_clicked; else no_fragment_clicked">
                <!-- Fragment information -->
                <h4>Selected {{this.current_fragment.author}}, {{this.current_fragment.title}}, 
                    {{this.current_fragment.editor}}, fragment {{this.current_fragment.fragment_name}}</h4> <hr>
            </div>
            <ng-template #no_fragment_clicked><h4>Click a fragment to show its content.</h4></ng-template>

            <!-- Show banner if no commentary available -->
            <div *ngIf="this.current_fragment.no_content" class="alert alert-info" role="alert">
                No content is available yet for this fragment.
            </div>
            
            <!-- Show the commentary for the clicked fragment -->
            <div *ngIf="this.fragment_has_content(this.current_fragment);">
                <ng-container [ngTemplateOutlet]='commentary_column_template' [ngTemplateOutletContext]="{given_fragment:this.current_fragment}"></ng-container>
            </div>
           
            <!-- <mat-expansion-panel>
                <mat-expansion-panel-header>
                    <mat-panel-title>
                        <b>About this author and title</b>
                    </mat-panel-title>
                </mat-expansion-panel-header>
                <h5>About Ennius</h5>
                <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.</p>
                <h5>About Eumenides</h5>
                <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.</p>
            </mat-expansion-panel> -->



            <!-- <hr> -->

            <div *ngFor="let linked_fragment of this.commentary_column.linked_fragments_content">
                <div *ngIf="this.fragment_has_content(linked_fragment);">
                    <h5>Linked commentary from {{linked_fragment.author}}, {{linked_fragment.title}}, 
                        {{linked_fragment.editor}}, fragment {{linked_fragment.fragment_name}}</h5>
                    <ng-container [ngTemplateOutlet]='commentary_column_template' [ngTemplateOutletContext]="{given_fragment:linked_fragment}"></ng-container>    
                </div>
            </div>

        </div>
        <!-- <hr> -->
    </div> <!-- This closes the first row. Other items will be put under this row -->
    


    <!-- Loading spinner to show data is being retrieved from the server -->
    <mat-toolbar *ngIf="this.utility.spinner === false" class="progress-toolbar-playground"></mat-toolbar>
    <mat-progress-bar *ngIf="this.utility.spinner" mode="query"></mat-progress-bar>
    <!-- Row to show the playground -->
    <hr>

    <!-- <div class="div-padding-lg"></div> -->
    <div class="container-fluid playground-height-padding" *ngIf="toggle_playground">               
        <div class="row">
            <!-- Possiblity to select an editor to begin with -->
            <div class="col-2"> <ng-container *ngTemplateOutlet="select_author;context:{column: this.playground}"></ng-container> </div>
            <div class="col-2"> <ng-container *ngTemplateOutlet="select_title;context:{column: this.playground}"></ng-container> </div>
            <div class="col-2"> <ng-container *ngTemplateOutlet="select_editor;context:{column: this.playground}"></ng-container> </div>   
            <div class="col-2">
                <mat-form-field class="select-form">
                    <mat-label>Select fragment</mat-label>
                    <mat-select>
                        <mat-option *ngFor="let fragment_name of this.playground.fragment_names" [value]="fragment_name"
                            (click)="add_single_fragment_to_playground(this.playground, fragment_name)">
                            {{ fragment_name }} 
                        </mat-option>
                    </mat-select>
                    <mat-hint>To add a single fragment</mat-hint>
                </mat-form-field>  
            </div>
            <div class="col-2"> <button mat-button (click)="this.request_fragments(this.playground)">Add full edition</button> </div>
            <div class="col-2"> <button mat-button (click)="this.delete_clicked_item_from_playground(this.playground, 'fragment')">Delete clicked fragment</button> </div>

            <!-- Possibility to add a little note -->
            <div mat-dialog-content class="col-6">
                <mat-form-field class="input-form" style="--width: 100%;">
                    <input matInput placeholder="Add a note" ngDefaultControl [(ngModel)]='note'>
                    <button type="button" mat-icon-button matSuffix (click)="this.playground.note_array = this.utility.push_to_array(note, this.playground.note_array)">
                        <mat-icon>{{'add'}}</mat-icon>
                    </button>
                    <mat-hint>To organise your edition</mat-hint>
                </mat-form-field>               
            </div>
            <div class="col-2"> <button mat-button (click)="this.delete_clicked_item_from_playground(this.playground, 'note')">Delete clicked note</button> </div>
            <div class="col-2"> <button mat-button (click)="this.playground.fragments = []; this.playground.note_array = [];">Clear playground</button> </div>
            <!-- <div class="col-2"> <button mat-button (click)="this.playground.fragments = []; this.playground.note_array = [];">Retrieve commentary</button> </div> -->
  
        </div>

        <hr>
        <!-- For loop to print all the notes -->
        <div *ngFor="let note of this.playground.note_array" class="note zlayer" style="--layer: 3;" (click)="this.playground.clicked_note = note" cdkDrag>
            {{note}}
        </div>
        <!-- For loop to print all the base selected fragments -->
        <!-- Recording the clicked fragment allows us to delete it when pressing the delete button -->
        <!-- Also, keep track whether we are dragging or not. If we drag, we do not want the click event to fire -->
        <div *ngFor="let fragment of this.playground.fragments" class="playground zlayer" style="--layer: 2;" cdkDrag #draggable="cdkDrag"
            
            (cdkDragStarted)="this.playground_dragging = true"
            (click)="this.handle_fragment_click(fragment, true)"
            (click)="this.playground.clicked_fragment = fragment">
            
            <b [style.color]="fragment.colour">Fragment {{fragment.fragment_name}} </b> &nbsp; <sup>{{fragment.author}}, {{fragment.title}}, {{fragment.editor}}</sup> &nbsp; <i>{{fragment.status}}</i>

            <div *ngFor="let line of fragment.lines">           
                <div [innerHTML]="line.line_complete"></div>
            </div> 
        </div>
    </div> <!-- Closes the row -->
</div>

<!-- (click)="this.handle_fragment_click(fragment, draggable._dragRef.isDragging())"> -->


<!-- TEMPLATES -->

<!-- Template for a fragment column -->
<ng-template #fragment_column_template let-given_column="given_column" let-hint="hint">  
    <div class="row">
        <div class="col-4"> <ng-container *ngTemplateOutlet="select_author;context:{column: given_column}"></ng-container> </div>
        <div class="col-4"> <ng-container *ngTemplateOutlet="select_title;context:{column: given_column}"></ng-container> </div>
        <div class="col-4"> <ng-container *ngTemplateOutlet="select_editor;context:{column: given_column}"></ng-container> </div>        
    </div>
    <!-- Fragments loop to display all fragments of the chosen edition of reference -->
    <div class="row">
        <!-- Columns are connected via the cdkDropListConnectedTo property. -->
        <div cdkDropList id="{{given_column.column_id}}" 
            [cdkDropListData]="given_column.fragments" 
            [cdkDropListConnectedTo]="connected_columns_list" 
            (cdkDropListDropped)="this.utility.drop($event)">
            <div *ngFor="let fragment of given_column.fragments"> 
                <div class="fragment-box" (click)="handle_fragment_click(fragment)" cdkDrag
                    [cdkDragDisabled]="this.oscc_settings.dragging_disabled"
                    [attr.id]="fragment.fragment_id">
                    <b [style.color]="fragment.colour">Fragment {{fragment.fragment_name}} </b> &nbsp; <sup>{{fragment.author}}, {{fragment.title}}, {{fragment.editor}}</sup> &nbsp; <i>{{fragment.status}}</i>
                    <div *ngFor="let fragment_line of fragment.lines">      
                        <div [innerHTML]="fragment_line.line_complete | safeHtml"></div>  <!--safeHtml to allow whitespaces             -->
                    </div>  
                </div>
            </div>
        </div> 
    </div>
</ng-template>

<ng-template #commentary_column_template let-given_fragment="given_fragment">  

    <ng-container *ngTemplateOutlet="show_fragment_content;
        context:{current_fragment_content: given_fragment.translation, title:'Fragment Translation'}">
    </ng-container> <!-- Show the translation of the fragment -->           

    <ng-container *ngTemplateOutlet="show_fragment_content;
        context:{current_fragment_content: given_fragment.apparatus, title:'Apparatus Criticus'}">
    </ng-container> <!-- Show the apparatus criticus of the fragment -->

    <ng-container *ngTemplateOutlet="show_fragment_content;
        context:{current_fragment_content: given_fragment.differences, title:'Editorial Differences'}">
    </ng-container> <!-- Show the fragment differences -->

    <div *ngFor="let current_context of given_fragment.context">
        <mat-expansion-panel>
            <mat-expansion-panel-header>
                <mat-panel-title>
                    <b>Citation Context</b>
                </mat-panel-title>
                <div>{{current_context.author}} <i>{{current_context.location}}</i></div><div class="div-padding-sm"></div>
            </mat-expansion-panel-header>
            <div class="mat-expansion-panel-content">
                <div class="mat-expansion-panel-body">
                    <div [innerHTML]="current_context.text"></div>
                </div>
            </div>
        </mat-expansion-panel>
    </div><hr> <!-- Show all context items for the selected fragment -->

    <ng-container 
        *ngTemplateOutlet="show_fragment_content;context:{current_fragment_content: given_fragment.commentary, title:'Fragment Commentary'}">
    </ng-container> <!-- Show the fragment commentary -->

    <ng-container 
        *ngTemplateOutlet="show_fragment_content;context:{current_fragment_content: given_fragment.reconstruction, title:'Fragment Reconstruction'}">
    </ng-container> <!-- Show the fragment reconstruction -->

</ng-template>

<!-- Template for the select author mat-option field -->
<ng-template #select_author let-column="column" let-hint="hint">  
    <mat-form-field class="selection-form">
        <mat-label>Author</mat-label>
        <mat-select>
            <mat-option *ngFor="let author of column.retrieved_authors" [value]="author"
                (click)="this.handle_author_selection(column, author.name)">
                {{ author.name }} 
            </mat-option>
        </mat-select>
        <mat-hint>{{hint}}</mat-hint>
    </mat-form-field> 
</ng-template>

<!-- Template for the select text title mat-option field -->
<ng-template #select_title let-column="column" let-hint="hint">   
    <mat-form-field class="selection-form">
        <mat-label>Text</mat-label>
        <mat-select>
            <mat-option *ngFor="let title of column.retrieved_titles" [value]="title" 
            (click)="this.handle_title_selection(column, title.name)">
                {{ title.name }}                
            </mat-option>
        </mat-select>
        <mat-hint>{{hint}}</mat-hint>
    </mat-form-field>
</ng-template>

<!-- Template for the select editor mat-option field -->
<ng-template #select_editor let-column="column" let-hint="hint">   
    <mat-form-field class="selection-form">
        <mat-label>Edition</mat-label>
        <mat-select>
            <mat-option *ngFor="let editor of column.retrieved_editors" [value]="editor"
                (click)="this.handle_editor_selection(column, editor.name)">
                {{ editor.name }}                     
            </mat-option>
        </mat-select>
        <mat-hint>{{hint}}</mat-hint>
    </mat-form-field>
</ng-template>
       
<!-- Template to show fragment content from the given fragment in a mat expansion panel -->
<ng-template #show_fragment_content let-current_fragment_content="current_fragment_content" let-title="title">   
    <mat-expansion-panel *ngIf="current_fragment_content">
        <mat-expansion-panel-header>
            <mat-panel-title>
                <b>{{title}}</b>
            </mat-panel-title>
        </mat-expansion-panel-header>
        <div class="mat-expansion-panel-content">
            <div class="mat-expansion-panel-body">
                <div [innerHTML]="current_fragment_content"></div>
            </div>
        </div>
    </mat-expansion-panel>
    <hr> <!-- And add a nice line to separate the fields -->
</ng-template>
