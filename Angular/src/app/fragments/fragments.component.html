<!-- Import the stylesheet for the Material icons -->
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<!-- I think this can be removed. -->
<!-- <script src="vendor/jquery/jquery.min.js"></script> -->
<!-- <script src="vendor/bootstrap/js/bootstrap.bundle.min.js"></script> -->


<!-- Maybe we should get a local stylesheet? -->
<!-- <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css"> -->

<!-- Navigation bar -->
<mat-toolbar color="primary">
    <span style="width: fit-content; transform: translateY(-1px)">
        <h3 
            *ngIf="this.window_size > 725; else small_title" 
            class='navbar'>
            Open Source Classics Commentary
        </h3>
    </span>

    <ng-template #small_title>
        <h3 class='navbar'>OSCC</h3>
    </ng-template>

    <span class="spacer"></span>
    
    <button mat-stroked-button 
        class="navbar" 
        *ngIf="this.auth_service.current_user_name == 'Lucus'"
        (click)="test('0')">
            TEST
    </button>
    
    <button mat-stroked-button 
        *ngIf="!this.commentary_enabled; else commentary_disabled"
        class="navbar button-padding" 
        (click)="this.toggle_commentary()">
            COMMENTARY
    </button>

    <ng-template #commentary_disabled>
        <button mat-flat-button 
        color="accent"
        class="button-padding"
        (click)="this.toggle_commentary()">
            COMMENTARY
        </button>    
    </ng-template>

    <button mat-stroked-button 
        *ngIf="!this.playground_enabled; else playground_disabled"
        class="navbar button-padding" 
        (click)="this.toggle_playground()">
            PLAYGROUND
    </button>

    <ng-template #playground_disabled>
        <button mat-flat-button 
        class="button-padding"
        color="accent"
        (click)="this.toggle_playground()">
            PLAYGROUND
        </button>    
    </ng-template>

    <button mat-stroked-button 
        class="navbar" 
        [matMenuTriggerFor]="menu">
            MENU
    </button>

</mat-toolbar>

<!-- Navigation bar menu -->
<mat-menu #menu="matMenu">
    <button (click)="login()" mat-menu-item>Login</button>
    <button mat-menu-item routerLink="/dashboard" *ngIf="this.auth_service.is_logged_in">Dashboard</button>
    <button mat-menu-item routerLink="/scansion" *ngIf="this.auth_service.is_logged_in">Scansion</button>
    <a href="https://github.com/Ycreak/OpensourceClassicCommentary/" target='_blank' mat-menu-item>Documentation</a>
    <button (click)="open_settings()" mat-menu-item>Settings</button>
    <button routerLink="/tests" mat-menu-item *ngIf="this.auth_service.is_logged_in">Unit Tests</button>
    <button (click)="this.dialog.open_about_dialog()" mat-menu-item>About</button>
    <div mat-menu-item>V22.11.16</div>
</mat-menu>

<!-- Loading spinner to show data is being retrieved from the server -->
<mat-toolbar *ngIf="this.utility.spinner === false" class="progress-toolbar"></mat-toolbar>
<mat-progress-bar *ngIf="this.utility.spinner" mode="query"></mat-progress-bar>

<!-- Secondary toolbar to manage columns -->
<mat-toolbar class="column-toolbar">    
    <div>
        <button class='navbar' mat-button (click)="add_column()">
            Add column
        </button>  
        | <!-- Separator-->
    </div>
     
    <ng-container *ngFor="let column_to_display of this.columns">
        <!-- Button to hide and show columns -->
        <button mat-icon-button matSuffix 
            (click)="column_to_display.visible = !column_to_display.visible" 
            [attr.aria-pressed]="column_to_display.visible">
                <mat-icon>{{column_to_display.visible ? 'visibility' : 'visibility_off'}}</mat-icon>
        </button>
        
        <!-- FIXME: This is in a button, because i cannot match the font properly -->
        <button class='navbar' mat-button>
            {{column_to_display.author}}-{{column_to_display.title}}-{{column_to_display.editor}} <sup *ngIf=column_to_display.edited>edited</sup>
        </button>  
        
        <!-- Buttons to close columns or to move columns to left and right -->
        <button mat-icon-button (click)="move_column(column_to_display.column_id, 'left')">
            <mat-icon>keyboard_arrow_left</mat-icon>
        </button>  

        <button mat-icon-button (click)="move_column(column_to_display.column_id, 'right')">
            <mat-icon>keyboard_arrow_right</mat-icon>
        </button>  

        <button mat-icon-button (click)="close_column(column_to_display.column_id)">
            <mat-icon>clear</mat-icon>
        </button>  

        | <!-- Separator-->

    </ng-container>
</mat-toolbar>


<div class="div-padding-sm"></div>

<!-- Display for if server is down -->
<div *ngIf="this.api.get_network_status() === false" class="alert alert-warning" role="alert" @fadeSlideInOut>
    Your client cannot connect to the server. Please check if you have the latest version of your browser installed. Furthermore, secured networks like DUWO and Leiden University are known to cause problems. Also, please click <u><a href="https://oscc.lucdh.nl">the following URL</a></u> for the best results. Please contact the administrators if problems are still occuring.
</div>

<!-- Container for the page. One row per item (commentary, playground, multiplayer, etc.) -->
<div class="container-fluid">

    <div class="row"> <!-- Row that contains the columns and commentary --> 
        <div *ngFor="let column_to_display of this.columns" class="col overflow_column" [hidden]="!column_to_display.visible">
                <ng-container [ngTemplateOutlet]='fragment_column_template' [ngTemplateOutletContext]="{given_column:column_to_display}"></ng-container>
        </div>

        <!-- Column with commentary, shown if a fragment from the edition of reference is clicked -->
        <div *ngIf="commentary_enabled" class="col overflow_column">
            <!-- Show either fragment data or the fact that no fragment has been selected yet. -->
            <div *ngIf="this.fragment_clicked; else no_fragment_clicked">
                <!-- Fragment information -->
                <h4>Selected 
                    <a class='a-void' (click)="this.request_introduction(this.current_fragment.author)">{{this.current_fragment.author}}</a>, <!-- Do not forget the comma and space -->
                    <a class='a-void' (click)="this.request_introduction(this.current_fragment.title)">{{this.current_fragment.title}}</a>, 
                    {{this.current_fragment.editor}}, 
                    fragment {{this.current_fragment.fragment_name}}
                </h4> <hr>
            </div>
            <ng-template #no_fragment_clicked><h4>Click a fragment to show its content.</h4></ng-template>

            <!-- Show banner if no commentary available -->
            <div *ngIf="!this.fragment_has_content(this.current_fragment);" class="alert alert-info" role="alert">
                No content is available yet for this specific fragment.
            </div>
            
            <!-- Show the commentary for the clicked fragment -->
            <div *ngIf="this.fragment_has_content(this.current_fragment);">
                <ng-container [ngTemplateOutlet]='commentary_column_template' [ngTemplateOutletContext]="{given_fragment:this.current_fragment}"></ng-container>
            </div>
           
            <div *ngFor="let linked_fragment of this.commentary_column.linked_fragments_content">
                <div *ngIf="this.fragment_has_content(linked_fragment);">
                    <h5>Linked commentary from {{linked_fragment.author}}, {{linked_fragment.title}}, 
                        {{linked_fragment.editor}}, fragment {{linked_fragment.fragment_name}}</h5>
                    <ng-container [ngTemplateOutlet]='commentary_column_template' [ngTemplateOutletContext]="{given_fragment:linked_fragment}"></ng-container>    
                </div>
            </div>

        </div>
        <!-- <hr> -->
    </div> <!-- This closes the first row. Other items will be put under this row -->
    


    <!-- Loading spinner to show data is being retrieved from the server -->
    <mat-toolbar *ngIf="this.utility.spinner === false" class="progress-toolbar-playground"></mat-toolbar>
    <mat-progress-bar *ngIf="this.utility.spinner" mode="query"></mat-progress-bar>
    <!-- Row to show the playground -->
    <hr>

    <!-- <div class="div-padding-lg"></div> -->
    <div class="container-fluid playground-height-padding" *ngIf="playground_enabled">               
        <div class="row">
            <!-- Possiblity to select an editor to begin with -->
            <div class="col-2"> <ng-container *ngTemplateOutlet="select_author;context:{column: this.playground}"></ng-container> </div>
            <div class="col-2"> <ng-container *ngTemplateOutlet="select_title;context:{column: this.playground}"></ng-container> </div>
            <div class="col-2"> <ng-container *ngTemplateOutlet="select_editor;context:{column: this.playground}"></ng-container> </div>   
            <div class="col-2">
                <mat-form-field class="select-form">
                    <mat-label>Select fragment</mat-label>
                    <mat-select>
                        <mat-option *ngFor="let fragment_name of this.playground.fragment_names" [value]="fragment_name"
                            (click)="add_single_fragment_to_playground(this.playground, fragment_name)">
                            {{ fragment_name }} 
                        </mat-option>
                    </mat-select>
                    <mat-hint>To add a single fragment</mat-hint>
                </mat-form-field>  
            </div>
            <div class="col-2"> <button mat-button (click)="this.request_fragments(this.playground)">Add full edition</button> </div>
            <div class="col-2"> <button mat-button (click)="this.delete_clicked_item_from_playground(this.playground, 'fragment')">Delete clicked fragment</button> </div>

            <!-- Possibility to add a little note -->
            <div mat-dialog-content class="col-6">
                <mat-form-field class="input-form" style="--width: 100%;">
                    <input matInput placeholder="Add a note" ngDefaultControl [(ngModel)]='note'>
                    <button type="button" mat-icon-button matSuffix (click)="this.playground.note_array = this.utility.push_to_array(note, this.playground.note_array)">
                        <mat-icon>{{'add'}}</mat-icon>
                    </button>
                    <mat-hint>To organise your edition</mat-hint>
                </mat-form-field>               
            </div>
            <div class="col-2"> <button mat-button (click)="this.delete_clicked_item_from_playground(this.playground, 'note')">Delete clicked note</button> </div>
            <div class="col-2"> <button mat-button (click)="this.playground.fragments = []; this.playground.note_array = [];">Clear playground</button> </div>
            <!-- <div class="col-2"> <button mat-button (click)="this.playground.fragments = []; this.playground.note_array = [];">Retrieve commentary</button> </div> -->
  
        </div>

        <hr>
        <!-- For loop to print all the notes -->
        <div *ngFor="let note of this.playground.note_array" class="note zlayer" style="--layer: 3;" (click)="this.playground.clicked_note = note" cdkDrag>
            {{note}}
        </div>
        <!-- For loop to print all the base selected fragments -->
        <!-- Recording the clicked fragment allows us to delete it when pressing the delete button -->
        <!-- Also, keep track whether we are dragging or not. If we drag, we do not want the click event to fire -->
        <div *ngFor="let fragment of this.playground.fragments" class="playground zlayer" style="--layer: 2;" cdkDrag #draggable="cdk
        "
            
            (cdkDragStarted)="this.playground_dragging = true"
            (click)="this.handle_fragment_click(fragment, true)"
            (click)="this.playground.clicked_fragment = fragment">
            
            <div *ngIf="this.oscc_settings.show_headers"><b [style.color]="fragment.colour">Fragment {{fragment.fragment_name}} </b> &nbsp; <sup>{{fragment.author}}, {{fragment.title}}, {{fragment.editor}}</sup> &nbsp; <i>{{fragment.status}}</i></div>

            <div *ngFor="let fragment_line of fragment.lines">           
                <p *ngIf="this.oscc_settings.show_line_names; else no_line_names_playground" [innerHTML]="fragment_line.line_number + ': ' + fragment_line.text | safeHtml"></p>
                <ng-template #no_line_names_playground>
                    <!--safeHtml to allow whitespaces made by spans-->
                    <p [innerHTML]="fragment_line.text | safeHtml"></p>
                </ng-template>
            </div> 
        </div>
    </div> <!-- Closes the row -->
</div>

<!-- TEMPLATES -->

<!-- Template for a fragment column -->
<ng-template #fragment_column_template let-given_column="given_column" let-hint="hint">  
    <div class="row">
        <div class="col-4"> <ng-container *ngTemplateOutlet="select_author;context:{column: given_column}"></ng-container> </div>
        <div class="col-4"> <ng-container *ngTemplateOutlet="select_title;context:{column: given_column}"></ng-container> </div>
        <div class="col-4"> <ng-container *ngTemplateOutlet="select_editor;context:{column: given_column}"></ng-container> </div>        
    </div>
    <!-- Fragments loop to display all fragments of the chosen edition of reference -->
    <div class="row">
        <!-- Columns are connected via the cdkDropListConnectedTo property. -->
        <div cdkDropList id="{{given_column.column_id}}" 
            [cdkDropListData]="given_column.fragments" 
            [cdkDropListConnectedTo]="connected_columns_list" 
            (cdkDropListDropped)="this.utility.drop($event)">
            <div *ngFor="let fragment of given_column.fragments"> 
                <div class="fragment-box" (click)="handle_fragment_click(fragment)" 
                    cdkDrag
                    [cdkDragDisabled]="this.oscc_settings.dragging_disabled"
                    (cdkDragDropped)="this.track_edited_columns($event)"
                    [attr.id]="fragment.fragment_id"
                    [style.border-left-color]="this.generate_fragment_gradient_color(given_column.fragments.length, given_column.orig_fragment_order.indexOf(fragment.fragment_name))">
                    <div *ngIf="this.oscc_settings.show_headers">
                        <b [style.color]="fragment.colour">Fragment {{fragment.fragment_name}} </b> &nbsp; <sup>{{fragment.author}}, {{fragment.title}}, {{fragment.editor}}</sup> &nbsp; <i>{{fragment.status}}</i>
                    </div>
                    <div *ngFor="let fragment_line of fragment.lines">      
                        <p *ngIf="this.oscc_settings.show_line_names; else no_line_names" [innerHTML]="fragment_line.line_number + ': ' + fragment_line.text | safeHtml"></p>
                        <ng-template #no_line_names>
                            <!--safeHtml to allow whitespaces made by spans-->
                            <p [innerHTML]="fragment_line.text | safeHtml"></p>
                        </ng-template>
                    </div>  
                </div>
            </div>
        </div> 
    </div>
</ng-template>

<ng-template #commentary_column_template let-given_fragment="given_fragment">  

    <ng-container *ngTemplateOutlet="show_fragment_content;
        context:{current_fragment_content: given_fragment.translation, title:'Fragment Translation'}">
    </ng-container> <!-- Show the translation of the fragment -->           

    <ng-container *ngTemplateOutlet="show_fragment_content;
        context:{current_fragment_content: given_fragment.apparatus, title:'Apparatus Criticus'}">
    </ng-container> <!-- Show the apparatus criticus of the fragment -->

    <ng-container *ngTemplateOutlet="show_fragment_content;
        context:{current_fragment_content: given_fragment.differences, title:'Editorial Differences'}">
    </ng-container> <!-- Show the fragment differences -->

    <div *ngFor="let current_context of given_fragment.context">
        <mat-expansion-panel>
            <mat-expansion-panel-header>
                <mat-panel-title>
                    <b>Citation Context</b>
                </mat-panel-title>
                <div>{{current_context.author}} <i>{{current_context.location}}</i></div><div class="div-padding-sm"></div>
            </mat-expansion-panel-header>
            <div class="mat-expansion-panel-content">
                <div class="mat-expansion-panel-body">
                    <div [innerHTML]="current_context.text"></div>
                </div>
            </div>
        </mat-expansion-panel>
    </div><hr> <!-- Show all context items for the selected fragment -->

    <ng-container 
        *ngTemplateOutlet="show_fragment_content;context:{current_fragment_content: given_fragment.commentary, title:'Fragment Commentary'}">
    </ng-container> <!-- Show the fragment commentary -->

    <ng-container 
        *ngTemplateOutlet="show_fragment_content;context:{current_fragment_content: given_fragment.reconstruction, title:'Fragment Reconstruction'}">
    </ng-container> <!-- Show the fragment reconstruction -->

</ng-template>

<!-- Template for the select author mat-option field -->
<ng-template #select_author let-column="column" let-hint="hint">  
    <mat-form-field class="selection-form">
        <mat-label>Author</mat-label>
        <mat-select>
            <mat-option *ngFor="let author of column.retrieved_authors" [value]="author"
                (click)="column.author = author.name"
                (click)="this.request_titles(column)">
                {{ author.name }} 
            </mat-option>
        </mat-select>
        <mat-hint>{{hint}}</mat-hint>
    </mat-form-field> 
</ng-template>

<!-- Template for the select text title mat-option field -->
<ng-template #select_title let-column="column" let-hint="hint">   
    <mat-form-field class="selection-form">
        <mat-label>Text</mat-label>
        <mat-select>
            <mat-option *ngFor="let title of column.retrieved_titles" [value]="title" 
                (click)="column.title = title.name"
                (click)="this.request_editors(column)">
                {{ title.name }}                
            </mat-option>
        </mat-select>
        <mat-hint>{{hint}}</mat-hint>
    </mat-form-field>
</ng-template>

<!-- Template for the select editor mat-option field -->
<ng-template #select_editor let-column="column" let-hint="hint">   
    <mat-form-field class="selection-form">
        <mat-label>Edition</mat-label>
        <ng-container *ngIf="column.name != 'playground'; else playground_editor_select">
            <mat-select>
                <mat-option 
                *ngFor="let editor of column.retrieved_editors" 
                [value]="editor"
                (click)="column.editor = editor.name"
                (click)="this.request_fragments(column)">
                {{ editor.name }}                     
                </mat-option>
            </mat-select>
        </ng-container>
        <!-- For playground, retrieve fragment names instead if directly loading an edition -->
        <ng-template #playground_editor_select>
          <mat-select>
            <mat-option 
              *ngFor="let editor of column.retrieved_editors" 
              [value]="editor"
              (click)="column.editor = editor.name"
              (click)="this.request_fragment_names(column)">
              {{ editor.name }}                     
            </mat-option>
          </mat-select>
        </ng-template>

        <mat-hint>{{hint}}</mat-hint>
    </mat-form-field>
</ng-template>
       
<!-- Template to show fragment content from the given fragment in a mat expansion panel -->
<ng-template #show_fragment_content let-current_fragment_content="current_fragment_content" let-title="title">   
    <mat-expansion-panel *ngIf="current_fragment_content">
        <mat-expansion-panel-header>
            <mat-panel-title>
                <b>{{title}}</b>
            </mat-panel-title>
        </mat-expansion-panel-header>
        <div class="mat-expansion-panel-content">
            <div class="mat-expansion-panel-body">
                <div [innerHTML]="current_fragment_content"></div>
            </div>
        </div>
    </mat-expansion-panel>
    <hr> <!-- And add a nice line to separate the fields -->
</ng-template>
